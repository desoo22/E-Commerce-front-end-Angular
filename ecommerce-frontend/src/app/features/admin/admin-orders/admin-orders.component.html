<div class="admin-orders">
  <div class="header">
    <h1><i class="fas fa-shopping-cart"></i> Order Management</h1>
  </div>

  <!-- Success/Error Messages -->
  <div *ngIf="success" class="alert alert-success">{{ success }}</div>
  <div *ngIf="error" class="alert alert-error">{{ error }}</div>

  <div *ngIf="loading" class="loading">Loading orders...</div>

  <table class="orders-table" *ngIf="!loading && orders.length > 0">
    <thead>
      <tr>
        <th style="width:32px;"></th>
        <th>Order ID</th>
        <th>Customer</th>
        <th>Phone</th>
        <th>Status</th>
        <th>Items</th>
        <th>Total</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <ng-container *ngFor="let order of orders">
        <tr [ngClass]="getRowClass(order.status)">
          <td style="text-align:center;">
            <button (click)="toggleExpand(order.orderId)" style="background:none;border:none;outline:none;cursor:pointer;font-size:18px;">
              <span [ngClass]="expandedOrderId === order.orderId ? 'fa fa-chevron-down' : 'fa fa-chevron-right'"></span>
            </button>
          </td>
          <td><strong>#{{ order.orderId }}</strong></td>
          <td>{{ order.user?.name || 'N/A' }}</td>
          <td>{{ order.phoneNumber || order.user?.phoneNumber || 'N/A' }}</td>
          <td>
            <span class="status-badge" [ngClass]="getStatusClass(order.status)">
              {{ order.status }}
            </span>
          </td>
          <td><strong>{{ order.itemCount || getTotalItems(order) }}</strong></td>
          <td><strong>{{ order.totalPrice | currency:'USD' }}</strong></td>
          <td>
            <select class="status-select" [value]="order.status" (change)="updateStatus(order.orderId, $any($event.target).value)">
              <option value="PendingPayment">Pending Payment</option>
              <option value="Shipped">Shipped</option>
              <option value="Delivered">Delivered</option>
              <option value="Cancelled">Cancelled</option>
            </select>
          </td>
        </tr>
        <tr *ngIf="expandedOrderId === order.orderId" [ngClass]="getRowClass(order.status)">
          <td colspan="8" style="background:#f9fafb; border-bottom:1px solid #e5e7eb;">
            <div style="padding:1em 2em;">
              <div style="margin-bottom:10px;">
                <strong>üìç Customer Info:</strong><br>
                <span *ngIf="order.user?.name"><i class="fa fa-user"></i> <strong>Name:</strong> {{ order.user?.name }}</span><br>
                <span *ngIf="order.email"><i class="fa fa-envelope"></i> <strong>Email:</strong> {{ order.email }}</span><br>
                <span *ngIf="order.phoneNumber || order.user?.phoneNumber"><i class="fa fa-phone"></i> <strong>Phone:</strong> {{ order.phoneNumber || order.user?.phoneNumber }}</span><br>
                <span *ngIf="order.city || order.street || order.neighborhood">
                  <i class="fa fa-map-marker"></i> <strong>Address:</strong> 
                  {{ order.street }}<span *ngIf="order.neighborhood">, {{ order.neighborhood }}</span><span *ngIf="order.city">, {{ order.city }}</span>
                </span>
              </div>
              <div style="margin-bottom:10px;">
                <strong>üì¶ Order Items:</strong>
                <ul style="margin:0; padding-left: 1.2em;">
                  <li *ngFor="let item of order.items">
                    <strong>{{ item.productName }}</strong> √ó {{ item.quantity }} - {{ item.unitPrice | currency:'USD' }}
                  </li>
                </ul>
                <div style="margin-top:8px;">
                  <strong>Total Items:</strong> <b style="color:#0066cc;">{{ order.itemCount || getTotalItems(order) }}</b>
                </div>
              </div>
              <div>
                <strong>üí∞ Total Price:</strong> <span style="color:#0066cc;font-weight:bold;font-size:1.1em;">{{ order.totalPrice | currency:'USD' }}</span>
              </div>
              <div style="margin-top:10px;">
                <strong>üìÖ Order Date:</strong> {{ order.createdAt | date:'medium' }}
              </div>
            </div>
          </td>
        </tr>
      </ng-container>
    </tbody>
  </table>

  <div *ngIf="!loading && orders.length === 0" class="empty-state">
    <i class="fas fa-shopping-cart fa-3x"></i>
    <p>No orders yet.</p>
  </div>
</div>
